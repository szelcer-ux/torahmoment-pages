<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TorahMoment ‚Äî Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="TorahMoment dashboard and stats" />

  <style>
    :root{
      --bg:#f7f7f8;
      --card:#ffffff;
      --text:#111;
      --muted:#666;
      --border:#e7e7ee;
      --accent:#0d9488;
      --shadow:0 6px 22px rgba(0,0,0,0.07);
      --radius:16px;
    }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width: 1060px;
      margin: 0 auto;
      padding: 20px;
    }

    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }

    h1{
      margin:0 0 2px;
      font-size: 1.65rem;
      letter-spacing: -0.02em;
    }

    .subtle{
      color:var(--muted);
      font-size: 0.95rem;
      line-height: 1.35;
    }

    .topActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      color:#111;
      text-decoration:none;
      font-weight:600;
      font-size:0.93rem;
      box-shadow: 0 1px 0 rgba(0,0,0,0.02);
    }
    .btn:hover{ border-color: rgba(13,148,136,0.35); }

    .btn.primary{
      background: rgba(13,148,136,0.12);
      border-color: rgba(13,148,136,0.22);
    }

    .card{
      background:var(--card);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      margin-top: 18px;
      border: 1px solid rgba(0,0,0,0.02);
    }

    /* Stats grid */
    .stats{
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 12px;
      margin-top: 14px;
    }

    .stat{
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 12px;
      box-shadow: 0 1px 0 rgba(0,0,0,0.02);
      min-height: 74px;
    }

    .stat .label{
      color: var(--muted);
      font-size: 0.82rem;
      margin-bottom: 6px;
    }

    .stat .value{
      font-size: 1.25rem;
      font-weight: 750;
      letter-spacing: -0.02em;
    }

    .stat .hint{
      margin-top: 4px;
      font-size: 0.82rem;
      color: var(--muted);
    }

    /* Program cards */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .prog{
      display:flex;
      gap: 12px;
      align-items:flex-start;
      padding: 14px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fbfbfd;
      text-decoration:none;
      color: var(--text);
      transition: transform .08s ease, box-shadow .08s ease, border-color .08s ease;
    }

    .prog:hover{
      transform: translateY(-1px);
      border-color: rgba(13,148,136,0.35);
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }

    .icon{
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: rgba(13,148,136,0.12);
      display:flex;
      align-items:center;
      justify-content:center;
      flex: 0 0 auto;
      font-size: 18px;
    }

    .prog h3{
      margin: 0 0 3px;
      font-size: 1.05rem;
      letter-spacing:-0.01em;
    }

    .prog .meta{
      color: var(--muted);
      font-size: 0.92rem;
      line-height: 1.25;
    }

    .prog .counts{
      margin-top: 8px;
      font-size: 0.88rem;
      color: #334155;
    }

    .prog .counts b{
      font-weight: 750;
      color: #0f172a;
    }

    .prog .arrow{
      margin-left:auto;
      color:#64748b;
      font-size: 18px;
      padding-top: 2px;
    }


    
    /* --- RECENT (ported from index) --- */
    .recentGroup{
  margin-top:22px;
  padding-top:16px;
  border-top:1px solid var(--border);
  font-size:12px;
  font-weight:800;
  letter-spacing:.08em;
  text-transform:uppercase;
  color:#64748b;
}

.recentGroup:first-of-type{
  margin-top:10px;
  border-top:0;
  padding-top:0;
}

    .recentItem{
  padding:10px 0;
}

    .recentGroup:first-child{
      margin-top: 0;
      border-top: none;
    }

    .recentRow{
      display:flex;
      gap:10px;
      padding:10px 10px;
      border-radius:10px;
      text-decoration:none;
      color:#111;
      align-items:center;
    }
    .recentRow:hover{ background:#f6f8fb; }

    .rIcon{ width:20px; text-align:center; }


/* Recently added container */
#recentList{
  padding: 8px 14px;
}

/* Group header (One-Minute / Halacha / Parsha) */
#recentList .recentGroup{
  margin-top: 18px;
  padding-top: 14px;
  border-top: 1px solid var(--border);
  font-size: 12px;
  font-weight: 800;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: #64748b;
}
#recentList .recentGroup:first-child{
  margin-top: 0;
  padding-top: 0;
  border-top: 0;
}

/* Each row */
#recentList .recentItem{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 14px;
  padding: 10px 6px;
  border-radius: 12px;
}
#recentList .recentItem:hover{
  background: rgba(0,0,0,0.02);
}

/* Left side: icon + title */
#recentList .ri-left{
  display:flex;
  align-items:center;
  gap: 10px;
  min-width: 0;
}
#recentList .ri-title{
  font-weight: 700;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
#recentList .ri-icon{
  width: 18px;
  text-align:center;
  opacity: .8;
}

/* Right side: date + player */
#recentList .ri-right{
  display:flex;
  align-items:center;
  gap: 12px;
  flex-shrink: 0;
}
#recentList .ri-date{
  font-size: 12px;
  color: #64748b;
  white-space: nowrap;
}

/* Optional badges */
#recentList .badge{
  display:inline-flex;
  align-items:center;
  padding: 3px 8px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 700;
  background: rgba(13,148,136,.12);
  color: #0d9488;
  margin-left: 8px;
}

    
    /* title/date line */
    .rLine{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .rTitle{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-weight:600;
    }
    .rDate{
      margin-left:auto;
      color:#666;
      font-size:0.82rem;
      white-space:nowrap;
    }

    .rLeft{ flex: 1; min-width: 0; }
    .rSub{
      margin-top:4px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    /* speed buttons hidden by default */
    .speedBtns{
      display:none;
      gap:8px;
      align-items:center;
    }
    .recentAudio.isActive .speedBtns{
      display:inline-flex;
    }
    .speedBtn{
      border:1px solid var(--border);
      background:#fff;
      padding:6px 10px;
      border-radius:999px;
      font-weight:650;
      font-size:0.85rem;
      cursor:pointer;
    }
    .speedBtn:hover{
      border-color: rgba(13,148,136,0.35);
    }
    .recentAudio .speedBtn.isOn{
      background: rgba(13,148,136,0.12);
      border-color: rgba(13,148,136,0.28);
    }

    /* long shiur badge */
    .longBadge{
      margin-left: 8px;
      padding: 2px 8px;
      font-size: 0.72rem;
      font-weight: 600;
      border-radius: 999px;
      background: rgba(13,148,136,0.12);
      color: #0d9488;
      white-space: nowrap;
    }

    /* Player */
    .rPlayer{
      width: 210px;
      min-width: 200px;
      transform: scale(0.92);
      transform-origin: right center;
    }

    /* Desktop layout: keep player in its own column */
    @media (min-width: 621px){
      .recentAudio{
        display:grid;
        grid-template-columns: 1fr auto;
        column-gap: 14px;
        align-items: center;
      }

      /* move speed buttons right, closer to the player */
      .recentAudio .rSub{
        display:flex;
        justify-content:flex-end;
        margin-top: 6px;
      }
      .recentAudio .speedBtns{
        margin-left: auto;
      }
    }

    /* Mobile: stack player under text */
    @media (max-width: 620px){
      .recentAudio{
        flex-direction: column;
        align-items: stretch;
      }
      .rPlayer{
        width: 100%;
        min-width: 0;
        transform: none;
      }

      /* Mobile title expand/collapse */
      .rTitle{
        display:inline-block;
        max-width: 100%;
        cursor:pointer;
      }
      .recentAudio.isTitleOpen .rTitle{
        white-space: normal;
        overflow: visible;
      }
    }

    /* muted box stays for fallback */
    .mutedBox{
      border:1px dashed var(--border);
      border-radius:12px;
      padding:12px;
      background:#fafafe;
      color:var(--muted);
      font-size:0.93rem;
    }

    footer{
      margin-top: 28px;
      text-align:center;
      color:#777;
      font-size:0.9rem;
    }

    @media (max-width: 980px){
      .stats{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }
    @media (max-width: 820px){
      header{ align-items:flex-start; flex-direction:column; }
      .topActions{ justify-content:flex-start; }
      .grid{ grid-template-columns: 1fr; }
      .wrap{ padding: 16px; }
      .stats{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }

/* ===== Recently Added ‚Äî style existing markup ===== */

/* Container */
#recentList{
  padding: 8px 14px;
}

/* Group headers (One-Minute / Halacha / Parsha) */
#recentList .recentGroup{
  margin-top: 18px;
  padding-top: 14px;
  border-top: 1px solid var(--border);
  font-size: 12px;
  font-weight: 800;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: #64748b;
}
#recentList .recentGroup:first-child{
  margin-top: 0;
  padding-top: 0;
  border-top: 0;
}

/* Row base (both audio div + video link) */
#recentList .recentRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 14px;
  padding: 10px 6px;
  border-radius: 12px;
  text-decoration: none; /* for <a> rows */
  color: inherit;
}
#recentList .recentRow:hover{
  background: rgba(0,0,0,0.02);
}

/* Left layout */
#recentList .rLeft{
  display:flex;
  flex-direction:column;
  gap: 6px;
  min-width: 0;
  flex: 1 1 auto;
}

#recentList .rLine{
  display:flex;
  align-items:center;
  gap: 10px;
  min-width: 0;
}

#recentList .rIcon{
  width: 18px;
  text-align:center;
  opacity: .85;
  flex: 0 0 auto;
}

#recentList .rTitle{
  font-weight: 700;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  min-width: 0;
}

/* Date sits to the right (keep it from squeezing title too early) */
#recentList .rDate{
  margin-left: auto;
  font-size: 12px;
  color: #64748b;
  white-space: nowrap;
  flex: 0 0 auto;
}

/* Player sizing */
#recentList .rPlayer{
  flex: 0 0 auto;
  width: 250px;
  max-width: 42vw; /* keeps it sane on narrower screens */
}

/* Speed buttons row */
#recentList .speedBtns{
  display:inline-flex;
  gap: 6px;
}
#recentList .speedBtn{
  border:1px solid var(--border);
  background:#fff;
  border-radius: 999px;
  padding: 4px 8px;
  font-weight: 700;
  font-size: 12px;
  cursor: pointer;
}
#recentList .speedBtn:hover{
  border-color: rgba(13,148,136,.35);
}

/* Long badge (your existing element) */
#recentList .longBadge{
  display:inline-flex;
  align-items:center;
  padding: 3px 8px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 700;
  background: rgba(13,148,136,.12);
  color: #0d9488;
}

/* Mobile: stack date + player nicely */
@media (max-width: 720px){
  #recentList .recentAudio{
    flex-direction: column;
    align-items: stretch;
  }
  #recentList .rDate{
    margin-left: 0;
  }
  #recentList .rPlayer{
    width: 100%;
    max-width: 100%;
  }
}

    
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Dashboard</h1>
        <div class="subtle">TorahMoment site stats and shortcuts</div>
      </div>

      <div class="topActions">
        <a class="btn" href="/index.html">üè† Home</a>
        <a class="btn primary" href="/parsha.html">üìñ Parsha</a>
        <a class="btn" href="/halacha.html">üìö Halacha</a>
        <a class="btn" href="/one-minute-audio.html">‚è±Ô∏è One-Minute</a>
        <a class="btn" href="/tefilah.html">üïç Tefilah</a>
      </div>
    </header>

    <!-- Top stats -->
    <section class="stats" aria-label="Stats">
      <div class="stat">
        <div class="label">Total shiurim</div>
        <div class="value" id="sTotal">‚Äî</div>
        <div class="hint">All programs</div>
      </div>

      <div class="stat">
        <div class="label">Last updated</div>
        <div class="value" id="sUpdated">‚Äî</div>
        <div class="hint">site-counts.json</div>
      </div>

      <div class="stat">
        <div class="label">Programs</div>
        <div class="value" id="sPrograms">‚Äî</div>
        <div class="hint">Counted buckets</div>
      </div>

      <div class="stat">
        <div class="label">Parsha total</div>
        <div class="value" id="sParsha">‚Äî</div>
        <div class="hint" id="sParshaHint">audio + video</div>
      </div>

      <div class="stat">
        <div class="label">Halacha total</div>
        <div class="value" id="sHalacha">‚Äî</div>
        <div class="hint">totalAll</div>
      </div>

      <div class="stat">
        <div class="label">One-Minute total</div>
        <div class="value" id="sOneMin">‚Äî</div>
        <div class="hint">audio</div>
      </div>

      <div class="stat">
        <div class="label">Tefilah total</div>
        <div class="value" id="sTefilah">‚Äî</div>
        <div class="hint">video</div>
      </div>

      <div class="stat">
        <div class="label">Parsha videos</div>
        <div class="value" id="sParshaV">‚Äî</div>
        <div class="hint">video</div>
      </div>

      <div class="stat">
        <div class="label">Parsha audio</div>
        <div class="value" id="sParshaA">‚Äî</div>
        <div class="hint">audio</div>
      </div>

      <div class="stat">
        <div class="label">Health</div>
        <div class="value" id="sHealth">‚Äî</div>
        <div class="hint">Basic checks</div>
      </div>

      <div class="stat">
        <div class="label">Mishna shiurim</div>
        <div class="value" id="sMishnaA">‚Äî</div>
        <div class="hint">audio</div>
      </div>

      <div class="stat">
        <div class="label">Raw JSON</div>
        <div class="value"><a href="/data/site-counts.json" style="color:#0b57d0;text-decoration:none;">Open</a></div>
        <div class="hint">Debug</div>
      </div>
    </section>

    <!-- Program shortcuts -->
    <section class="card">
      <h2 style="margin:0 0 10px;">Programs</h2>
      <div class="grid">
        <a class="prog" href="/parsha.html">
          <div class="icon">üìñ</div>
          <div>
            <h3>Parsha</h3>
            <div class="meta">Videos ¬∑ Audio ¬∑ PDFs</div>
            <div class="counts"><b id="cParsha">‚Äî</b> items</div>
          </div>
          <div class="arrow">‚Ä∫</div>
        </a>

        <a class="prog" href="/halacha.html">
          <div class="icon">üìö</div>
          <div>
            <h3>Halacha / Hashkafa</h3>
            <div class="meta">Audio shiurim</div>
            <div class="counts"><b id="cHalacha">‚Äî</b> items</div>
          </div>
          <div class="arrow">‚Ä∫</div>
        </a>

        <a class="prog" href="/one-minute-audio.html">
          <div class="icon">‚è±Ô∏è</div>
          <div>
            <h3>One-Minute Audio</h3>
            <div class="meta">Short daily ideas</div>
            <div class="counts"><b id="cOneMin">‚Äî</b> items</div>
          </div>
          <div class="arrow">‚Ä∫</div>
        </a>

        <a class="prog" href="/tefilah.html">
          <div class="icon">üïç</div>
          <div>
            <h3>Biur Shemona Esrei</h3>
            <div class="meta">Video shiurim</div>
            <div class="counts"><b id="cTefilah">‚Äî</b> items</div>
          </div>
          <div class="arrow">‚Ä∫</div>
        </a>

        <a class="prog" href="/mishna.html">
          <div class="icon">üìñ</div>
          <div>
            <h3>Mishna Audio</h3>
            <div class="meta">2 Mishnas a Day</div>
            <div class="counts"><b id="cMishna">‚Äî</b> items</div>
          </div>
          <div class="arrow">‚Ä∫</div>
        </a>

        <a class="prog" href="/torahprograms.html" style="background:#eefaf3">
          <div class="icon" style="background: rgba(34,197,94,0.12);">ü§ù</div>
          <div>
            <h3>Torah Programs</h3>
            <div class="meta">Learning initiatives & WhatsApp signups</div>
            <div class="counts"><b>Explore</b> ‚Üí</div>
          </div>
          <div class="arrow">‚Ä∫</div>
        </a>
      </div>
    </section>

    <!-- Recent -->
    <section class="card">
      <h2 style="margin:0 0 8px;">Recently added</h2>
      <div class="subtle" style="margin-bottom:12px;">3 One-Minute ¬∑ 2 Halacha ¬∑ 1 Parsha</div>
      <div id="recentList" class="mutedBox">Loading‚Ä¶</div>
    </section>

    <footer>
      ¬© <span id="yr"></span> TorahMoment.com
    </footer>
  </div>

  <script>
    document.getElementById("yr").textContent = new Date().getFullYear();

    function animateNumber(el, target, opts = {}) {
      if (!el) return;
      const duration = opts.duration ?? 650;
      const start = 0;
      const t0 = performance.now();

      function tick(now) {
        const p = Math.min(1, (now - t0) / duration);
        const eased = 1 - Math.pow(1 - p, 3);
        const val = Math.round(start + (target - start) * eased);
        el.textContent = val.toLocaleString();
        if (p < 1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    function safeNum(x){ return (typeof x === "number" && Number.isFinite(x)) ? x : 0; }

function parseISODateSmart(iso){
  if (!iso) return null;

  const s = String(iso);

  // Case 1: plain date (YYYY-MM-DD)
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m){
    const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
    return { date: new Date(y, mo - 1, d), useUTC: false };
  }

  // Case 2: UTC timestamp (ends with Z)
  const isUTC = /Z$/.test(s);
  const dt = new Date(s);
  if (!isFinite(dt)) return null;

  return { date: dt, useUTC: isUTC };
}

function fmtShortDate(iso){
  const parsed = parseISODateSmart(iso);
  if (!parsed) return "";

  return parsed.date.toLocaleDateString(undefined, {
    year: "numeric",
    month: "short",
    day: "numeric",
    timeZone: parsed.useUTC ? "UTC" : undefined
  });
}

function fmtDate(iso){
  return fmtShortDate(iso);
}


    function renderRecentCurated(data){
      const wrap = document.getElementById("recentList");
      if (!wrap) return;

      const by = data?.recentByProgram || {};
      const one = Array.isArray(by.oneMinute) ? by.oneMinute : [];
      const hal = Array.isArray(by.halacha) ? by.halacha : [];
      const par = Array.isArray(by.parsha) ? by.parsha : [];

      const curated = [
        ...one.slice(0, 3).map(x => ({ ...x, _group: "One-Minute" })),
        ...hal.slice(0, 2).map(x => ({ ...x, _group: "Halacha", _isHalacha: true })),
        ...par.slice(0, 1).map(x => ({ ...x, _group: "Parsha" })),
      ].filter(x => x && x.url);

      if (!curated.length){
        wrap.className = "mutedBox";
        wrap.innerHTML = `
          <div style="text-align:center">
            <a href="/parsha.html" style="color:#0b57d0;text-decoration:none;font-weight:650;">
              ‚ñ∂ View latest content
            </a>
          </div>`;
        return;
      }

      wrap.className = "";

      let lastGroup = null;
      wrap.innerHTML = curated.map(x => {
        const header = (x._group !== lastGroup)
          ? `<div class="recentGroup">${x._group}</div>`
          : "";
        lastGroup = x._group;

        const dateLabel = fmtShortDate(x.date);

        if (x.type === "audio") {
          const safeUrl = String(x.url || "");
          return `
            ${header}
            <div class="recentRow recentAudio" data-kind="audio" data-url="${safeUrl}" ${x._isHalacha ? 'data-halacha="true"' : ''}>
              <div class="rLeft">
                <div class="rLine">
                  <span class="rIcon">üéß</span>
                  <span class="rTitle rToggleTitle" role="button" tabindex="0">${(x.title && String(x.title).trim()) ? x.title : "Shiur"}</span>
                  <span class="longBadge" hidden>Long shiur</span>
                  <span class="rDate">${dateLabel}</span>
                </div>

                <div class="rSub">
                  <span class="speedBtns" aria-label="Playback speed">
                    <button type="button" class="speedBtn" data-speed="1">1x</button>
                    <button type="button" class="speedBtn" data-speed="1.5">1.5x</button>
                    <button type="button" class="speedBtn" data-speed="2">2x</button>
                  </span>
                </div>
              </div>

              <audio class="rPlayer" controls preload="metadata" src="${safeUrl}"></audio>
            </div>
          `;
        }

        // Video (Parsha): keep link behavior
        return `
          ${header}
          <a class="recentRow recentVideo" href="${x.url}" target="_blank" rel="noopener">
            <span class="rIcon">üì∫</span>
            <span class="rTitle">${(x.title && String(x.title).trim()) ? x.title : "Shiur"}</span>
            <span class="rDate">${dateLabel}</span>
          </a>
        `;
      }).join("");
    }

    function setupRecentAudioBehavior(){
      const list = document.getElementById("recentList");
      if (!list) return;

      function setActiveRow(row){
        list.querySelectorAll(".recentAudio.isActive").forEach(r => {
          if (r !== row) r.classList.remove("isActive");
        });
        row.classList.add("isActive");
      }

      function pauseOthers(keepAudio){
        list.querySelectorAll("audio.rPlayer").forEach(a => {
          if (a !== keepAudio && !a.paused) a.pause();
        });
      }

      function setSpeed(row, speed){
        const audio = row.querySelector("audio.rPlayer");
        if (!audio) return;

        audio.playbackRate = speed;

        row.querySelectorAll(".speedBtn").forEach(btn => {
          const s = Number(btn.dataset.speed);
          btn.classList.toggle("isOn", s === speed);
        });
      }

      function markLongShiur(row){
        if (row.dataset.halacha !== "true") return;

        const audio = row.querySelector("audio.rPlayer");
        const badge = row.querySelector(".longBadge");
        if (!audio || !badge) return;

        audio.addEventListener("loadedmetadata", () => {
          if (Number.isFinite(audio.duration) && audio.duration > 10 * 60) {
            badge.hidden = false;
          }
        }, { once: true });
      }

      // Mark long shiur badges ASAP (preload=metadata)
      list.querySelectorAll(".recentAudio").forEach(markLongShiur);

      // Speed buttons / activate row
      list.addEventListener("click", (e) => {
        const speedBtn = e.target.closest(".speedBtn");
        if (speedBtn){
          e.preventDefault();
          e.stopPropagation();

          const row = speedBtn.closest(".recentAudio");
          if (!row) return;

          setActiveRow(row);
          const speed = Number(speedBtn.dataset.speed) || 1;
          setSpeed(row, speed);
          return;
        }

        // Title expand/collapse (mobile only)
        const title = e.target.closest(".rToggleTitle");
        if (title && window.matchMedia("(max-width: 620px)").matches){
          e.preventDefault();
          e.stopPropagation();

          const row = title.closest(".recentAudio");
          if (!row) return;

          list.querySelectorAll(".recentAudio.isTitleOpen").forEach(r => {
            if (r !== row) r.classList.remove("isTitleOpen");
          });
          row.classList.toggle("isTitleOpen");
          return;
        }

        const row = e.target.closest(".recentAudio");
        if (row){
          if (e.target.closest("audio")) return; // don't hijack audio controls
          setActiveRow(row);

          // default speed highlight if user clicks row first
          const anyOn = row.querySelector(".speedBtn.isOn");
          if (!anyOn) setSpeed(row, 1);
        }
      });

      // Pause others when playing
      list.addEventListener("play", (e) => {
        const audio = e.target.closest("audio.rPlayer");
        if (!audio) return;

        pauseOthers(audio);

        const row = audio.closest(".recentAudio");
        if (row){
          setActiveRow(row);

          const anyOn = row.querySelector(".speedBtn.isOn");
          if (!anyOn) setSpeed(row, 1);
        }
      }, true);
    }

    async function loadDashboard(){
      try{
        const res = await fetch("/data/site-counts.json", { cache: "no-store" });
        if (!res.ok) throw new Error("site-counts.json not found");
        const data = await res.json();

        const all = data?.allShiurim || {};
        const b = all?.breakdown || {};

        const total = all?.total;
        const updatedStr = all?.updated;

        // totals per program (matching your schema)
        const parshaA = safeNum(b?.parsha?.audio);
        const parshaV = safeNum(b?.parsha?.video);
        const parshaT = parshaA + parshaV;

        const oneMin = safeNum(b?.oneMinute?.audio);
        const halacha = safeNum(b?.halacha?.totalAll);
        const tefilahV = safeNum(b?.tefila?.video);
        const mishnaA = safeNum(b?.mishna?.audio);

        const programCount = Object.keys(b || {}).length || 0;

        // Top stats
        if (typeof total === "number") animateNumber(document.getElementById("sTotal"), total);
        else document.getElementById("sTotal").textContent = "‚Äî";

        document.getElementById("sPrograms").textContent = String(programCount);

        if (updatedStr) {
          const d = new Date(updatedStr + "T00:00:00");
          document.getElementById("sUpdated").textContent = isFinite(d) ? d.toLocaleDateString() : updatedStr;
        } else {
          document.getElementById("sUpdated").textContent = "‚Äî";
        }

        animateNumber(document.getElementById("sParsha"), parshaT);
        animateNumber(document.getElementById("sHalacha"), halacha);
        animateNumber(document.getElementById("sOneMin"), oneMin);
        animateNumber(document.getElementById("sTefilah"), tefilahV);

        animateNumber(document.getElementById("sParshaV"), parshaV);
        animateNumber(document.getElementById("sParshaA"), parshaA);
        animateNumber(document.getElementById("sTefilahV"), tefilahV);
        animateNumber(document.getElementById("sMishnaA"), mishnaA);

        // Card counts
        document.getElementById("cParsha").textContent = parshaT.toLocaleString();
        document.getElementById("cHalacha").textContent = halacha.toLocaleString();
        document.getElementById("cOneMin").textContent = oneMin.toLocaleString();
        document.getElementById("cTefilah").textContent = tefilahV.toLocaleString();
        document.getElementById("cMishna").textContent = mishnaA.toLocaleString();

        // Health checks
        const health = [];
        if (!updatedStr) health.push("missing updated");
        if (!Number.isFinite(total)) health.push("missing total");
        if (programCount === 0) health.push("missing breakdown");
        document.getElementById("sHealth").textContent = health.length ? "‚ö†" : "OK";

        // Recent (curated + inline players)
        renderRecentCurated(data);
        setupRecentAudioBehavior();

      } catch (e){
        console.warn("Dashboard load failed", e);
        const box = document.getElementById("recentList");
        if (box) {
          box.className = "mutedBox";
          box.textContent = "Could not load dashboard data.";
        }
      }
    }

    loadDashboard();
  </script>
</body>
</html>
