<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>One minute audio לע&quot;נ הרב אברהם נתנאל צוקער ז&quot;ל</title>

<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f6f7f9;margin:0;padding:18px;color:#111}
.wrap{max-width:980px;margin:0 auto}
h1{text-align:center;margin-bottom:4px}
.subtitle{text-align:center;font-size:1.1rem;color:#555;margin-bottom:16px}

/* ✅ Simple TorahMoment link under subtitle */
.brand{
  text-align:center;
  margin-top:-10px;
  margin-bottom:14px;
  font-size:12px;
  color:#888;
}
.brand a{
  color:inherit;
  text-decoration:none;
  border-bottom:1px dotted #c7cbd1;
}
.brand a:hover{
  color:#111;
  border-bottom-color:#111;
}

.bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0 14px}
input{flex:1;min-width:240px;padding:10px 12px;border:1px solid #d0d5dd;border-radius:10px;font-size:16px}
.pill{padding:8px 10px;background:#fff;border:1px solid #e5e7eb;border-radius:999px;font-size:14px}
.speed button{padding:6px 10px;border-radius:999px;border:1px solid #d0d5dd;background:#fff;cursor:pointer}
.speed button.active{font-weight:700}
.player{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-bottom:14px}
.now{font-size:14px;color:#444;margin-bottom:8px}
audio{width:100%}
.row{
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:12px;
  padding:8px 10px;     /* ✅ smaller */
  margin-bottom:6px;    /* ✅ tighter spacing */
  cursor:pointer;
}

.row.playing{outline:2px solid #111}
.meta{font-size:13px;color:#667085;margin-bottom:6px}
.desc{font-size:16px}

/* ✅ Gentle “modern” feel without changing layout */
.row{
  transition: transform .06s ease, box-shadow .12s ease;
}
.row:hover{
  transform: translateY(-1px);
  box-shadow: 0 6px 14px rgba(0,0,0,.08);
}
.row:active{
  transform: scale(.99);
}

.head{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:nowrap;      /* ✅ never wrap to second line */
  width:100%;
}

.date{
  flex:0 0 auto;
  font-size:13px;
  color:#667085;
  white-space:nowrap;
}

.title{
  flex:1 1 auto;
  min-width:0;          /* ✅ CRITICAL: allows shrinking */
  font-size:15px;

  /* optional but recommended */
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;   /* ✅ force single line */
}


  
/* Compact mobile layout + tap-to-reveal speed buttons */
@media (max-width: 600px){
  body{padding:12px}
  .bar{gap:8px}
  input{width:100%; min-width:0}

  #sortBtn{padding:6px 10px}
  #count{padding:6px 10px}

  .row{padding:7px 9px; margin-bottom:5px}
  .meta{font-size:12px; margin-bottom:4px}
  .desc{font-size:15px; line-height:1.2}

  /* Hide speed buttons by default on mobile */
  .controls .speedBtns{display:none}

  /* Show when row is opened */
  .row.isOpen .controls .speedBtns{
    display:flex;
    gap:6px;
    flex-wrap:wrap;
    margin-top:8px;
  }

  .controls .speedBtns button{
    padding:5px 8px;
    font-size:13px;
  }

  audio{margin-top:6px}
}

/* ✅ Hide speed buttons by default everywhere */
.controls .speedBtns{display:none}

/* ✅ Show only when row is opened */
.row.isOpen .controls .speedBtns{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  margin-top:8px;
}

  .controls .speedBtns button{
  padding:6px 10px;
  font-size:13px;
  border-radius:999px;           /* ✅ fully rounded */
  border:1px solid #d0d5dd;
  background:#fff;
  cursor:pointer;
}
.controls .speedBtns button.active{
  font-weight:700;
  border-color:#111;
}

  .head{
  display:flex !important;
  flex-direction:row !important;
  flex-wrap:nowrap !important;
  align-items:center !important;
  gap:8px !important;
  width:100% !important;
}

.date{
  flex:0 0 auto !important;
  white-space:nowrap !important;
  font-size:13px;
  color:#667085;
}

.title{
  flex:1 1 auto !important;
  min-width:0 !important;          /* critical */
  white-space:nowrap !important;   /* force single line */
  overflow:hidden !important;
  text-overflow:ellipsis !important;
}

 .row{padding:10px}
audio{margin-top:6px}

  
</style>
</head>

<body>
<div class="wrap">

<h1>One minute audio</h1>
<div class="subtitle">לע״נ הרב אברהם נתנאל צוקער זצ״ל</div>

<!-- ✅ Step 6: simple branded link -->
<div class="brand">
  <a href="https://torahmoment.com" rel="noopener">TorahMoment.com</a>
</div>

<div class="bar">
  <input id="q" placeholder="Search…" />
  <button class="pill" id="sortBtn">Latest ↓</button>
  <div class="pill" id="count">0 items</div>
</div>

<div id="list"></div>
</div>

<!-- ✅ Keep this ONCE (and in the right place) -->
<script src="/data/site-counts.js"></script>

<script>
const DATA_URL = "./data.json";

const q = document.getElementById("q");
const list = document.getElementById("list");
const count = document.getElementById("count");
const sortBtn = document.getElementById("sortBtn");

let items = [];
let filtered = [];
let sortLatestFirst = true;

function pauseAllExcept(current){
  document.querySelectorAll("audio").forEach(a=>{
    if (a !== current) a.pause();
  });
}

function esc(s){
  return (s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))
}

function getSavedRate(){
  return Number(localStorage.getItem("rate") || "1");
}
function setSavedRate(r){
  localStorage.setItem("rate", String(r));
}

/* ✅ Sort uses precomputed _sortKey */
function sortItems(){
  filtered.sort((a,b)=> sortLatestFirst ? (b._sortKey - a._sortKey) : (a._sortKey - b._sortKey));
}

function render(){
  sortItems();
  list.innerHTML = "";
  count.textContent = filtered.length + " items";

  // ✅ Feed the site-wide counter (for the GitHub Action JSON build)
  if (window.SITE_COUNTS?.allShiurim?.breakdown) {
    window.SITE_COUNTS.allShiurim.breakdown.oneMinute.audio = filtered.length;
    window.SITE_COUNTS.allShiurim.updated = new Date().toISOString().slice(0, 10);
  }

  const defaultRate = getSavedRate();

  filtered.forEach(it=>{
    const row = document.createElement("div");
    row.className = "row";

    const speeds = [1, 1.25, 1.5, 2];

    row.innerHTML = `
      <div class="head">
        <div class="date">${esc(it.date)}</div>
        <div class="title">${esc(it.description)}</div>
    </div>


      <div class="controls">
        <div class="speedBtns" data-id="${it.id}">
          ${speeds.map(r => `<button type="button" data-rate="${r}" class="${r===defaultRate?'active':''}">${r}×</button>`).join("")}
        </div>
      </div>

      <audio controls preload="none" data-audio-id="${it.id}">
        <source src="${esc(it.url)}" type="audio/mpeg">
      </audio>
    `;

    list.appendChild(row);

    // Tap to open speed buttons (mobile), but don't interfere with audio controls
    row.addEventListener("click", (e) => {
      if (e.target.closest("audio") || e.target.closest(".speedBtns")) return;
      row.classList.toggle("isOpen");
    });

    // apply default rate immediately to the audio element
    const audioEl = row.querySelector(`audio[data-audio-id="${it.id}"]`);
    audioEl.playbackRate = defaultRate;

    audioEl.addEventListener("play", () => {
      pauseAllExcept(audioEl);

      // Open this row, close others (mobile UX)
      document.querySelectorAll(".row.isOpen").forEach(r => {
        if (r !== row) r.classList.remove("isOpen");
      });
      row.classList.add("isOpen");

      // ✅ Nice simple UX: keep the playing row in view
      row.scrollIntoView({behavior:"smooth", block:"center"});
    });
  });

  // one event handler for all speed buttons (event delegation)
  list.querySelectorAll(".speedBtns").forEach(box => {
    box.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-rate]");
      if(!btn) return;

      const id = box.getAttribute("data-id");
      const rate = Number(btn.getAttribute("data-rate"));

      // set this audio's rate
      const audioEl = list.querySelector(`audio[data-audio-id="${id}"]`);
      if(audioEl) audioEl.playbackRate = rate;

      // remember globally (so new rows + future sessions match)
      setSavedRate(rate);

      // update active button styling for this row
      box.querySelectorAll("button").forEach(b => b.classList.toggle("active", b===btn));
    });
  });
}

function applySearch(){
  const v = (q.value||"").toLowerCase().trim();
  if(!v){
    filtered = items.slice();
  } else {
    filtered = items.filter(it =>
      (it.description||"").toLowerCase().includes(v) ||
      (it.date||"").toLowerCase().includes(v)
    );
  }
  render();
}

// Sort toggle
sortBtn.onclick = () => {
  sortLatestFirst = !sortLatestFirst;
  sortBtn.textContent = sortLatestFirst ? "Latest ↓" : "Oldest ↑";
  render();
};

q.oninput = applySearch;

// ✅ Sort by JSON date field like "9/8/2024"
function dateToKey(mdy){
  const m = String(mdy || "").trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (!m) return 0;
  const mm = Number(m[1]);
  const dd = Number(m[2]);
  const yyyy = Number(m[3]);
  return Date.UTC(yyyy, mm - 1, dd);
}

fetch(DATA_URL, { cache:"no-store" })
.then(r=>r.json())
.then(d=>{
  items = d.map((x, idx) => ({
    ...x,
    id: x.id ?? idx,
    _sortKey: dateToKey(x.date)
  }));

  filtered = items.slice();
  sortLatestFirst = true;
  sortBtn.textContent = "Latest ↓";
  render();
});
</script>

<!-- (Optional) You can remove this whole block if you don't use ONE_MINUTE_AUDIO vars.
     Your main render() already updates SITE_COUNTS based on filtered.length -->
<script>
(function updateOneMinuteCount() {
  if (!window.SITE_COUNTS?.allShiurim?.breakdown) return;

  function countAllItems(obj) {
    if (!obj) return 0;
    if (Array.isArray(obj)) return obj.length;
    if (typeof obj === "object") {
      return Object.values(obj).reduce((sum, v) => sum + (Array.isArray(v) ? v.length : 0), 0);
    }
    return 0;
  }

  const oneMinuteItems =
    (typeof ONE_MINUTE_AUDIO !== "undefined") ? ONE_MINUTE_AUDIO :
    (typeof ONE_MINUTE_LIST !== "undefined") ? ONE_MINUTE_LIST :
    (typeof AUDIO_ITEMS !== "undefined") ? AUDIO_ITEMS :
    null;

  const total = countAllItems(oneMinuteItems);

  window.SITE_COUNTS.allShiurim.breakdown.oneMinute.audio = total;
  window.SITE_COUNTS.allShiurim.updated = new Date().toISOString().slice(0,10);

  console.log("✅ Updated One-Minute count:", total);
})();
</script>

</body>
</html>
